# План реализации фичи мержа файла gitignore.toml

## Описание фичи

Файл `how_to_do_gitignore.toml` содержит максимально широкий исходный набор правил, разбитых по категориям, из которого формируются правила для создания файла `.gitignore`. При инсталляции у пользователя может оказаться свой файл, дополненный своими правилами. Поэтому важно при инсталляции сделать мерж файла из дистрибутива и файл, который есть у пользователя.

## Текущее состояние

- Файл `how_to_do_gitignore.toml` содержит правила в формате TOML с категориями
- Функция `load_gitignore_rules()` загружает правила из файла
- Сейчас при установке файл просто копируется через `check_and_backup_file()` в `install.sh`
- Нет логики мержа пользовательских правил с правилами из дистрибутива

## Чек-лист реализации

### 1. Анализ и проектирование
- [ ] Проанализировать структуру TOML файла и возможные конфликты при мерже
- [ ] Определить стратегию мержа (объединение, перезапись, дополнение)
- [ ] Спроектировать алгоритм разрешения конфликтов между категориями
- [ ] Определить приоритеты: дистрибутив vs пользовательские правила

### 2. Создание функции мержа TOML файлов
- [ ] Создать функцию `merge_gitignore_toml_files(distributor_path: str, user_path: str) -> Dict`
- [ ] Реализовать парсинг TOML файлов с обработкой ошибок
- [ ] Создать логику объединения категорий (OperatingSystem, IDE, Python, etc.)
- [ ] Реализовать дедупликацию правил внутри категорий
- [ ] Добавить валидацию структуры TOML после мержа

### 3. Алгоритм мержа категорий
- [ ] Реализовать мерж по принципу "объединение уникальных правил"
- [ ] Добавить логику сортировки правил внутри категории
- [ ] Реализовать обработку комментариев и метаданных
- [ ] Создать функцию `deduplicate_patterns(patterns: List[str]) -> List[str]`

### 4. Обновление функции установки
- [ ] Модифицировать `check_and_backup_file()` в `install.sh` для gitignore.toml
- [ ] Добавить вызов функции мержа вместо простого копирования
- [ ] Создать функцию `merge_and_backup_gitignore_toml()`
- [ ] Добавить обработку ошибок мержа с fallback на копирование

### 5. Обновление Python кода
- [ ] Добавить функцию `merge_gitignore_rules()` в `how_to_do.py`
- [ ] Модифицировать `load_gitignore_rules()` для поддержки мержа
- [ ] Создать функцию `save_merged_gitignore_toml(content: Dict, path: str)`
- [ ] Добавить валидацию структуры после мержа

### 6. Обработка ошибок и edge cases
- [ ] Обработка случая отсутствия пользовательского файла
- [ ] Обработка некорректного TOML в пользовательском файле
- [ ] Fallback на дистрибутивный файл при ошибках
- [ ] Логирование процесса мержа для диагностики

### 7. Тестирование
- [ ] Создать unit тесты для функции мержа
- [ ] Тестировать различные сценарии конфликтов
- [ ] Проверить корректность мержа с реальными файлами
- [ ] Тестировать обработку ошибок и edge cases

### 8. Документация
- [ ] Обновить документацию по установке
- [ ] Добавить описание процесса мержа в README
- [ ] Создать примеры пользовательских правил
- [ ] Документировать формат TOML файла

### 9. Интеграция с существующей логикой
- [ ] Убедиться, что `analyze_project_for_gitignore()` работает с мерженным файлом
- [ ] Проверить совместимость с командой `generate_gitignore`
- [ ] Обновить логирование для отслеживания источника правил

### 10. Оптимизация и производительность
- [ ] Оптимизировать алгоритм дедупликации для больших файлов
- [ ] Добавить кэширование результатов мержа
- [ ] Минимизировать I/O операции при установке
- [ ] Оптимизировать использование памяти при обработке больших файлов

## Детальная реализация функций

### Функция мержа TOML файлов
```python
def merge_gitignore_toml_files(distributor_path: str, user_path: str) -> Dict[str, List[str]]:
    """
    Объединяет правила из дистрибутивного и пользовательского TOML файлов.
    
    Args:
        distributor_path: Путь к файлу из дистрибутива
        user_path: Путь к пользовательскому файлу
        
    Returns:
        Объединенный словарь категорий и правил
    """
```

### Функция дедупликации правил
```python
def deduplicate_patterns(patterns: List[str]) -> List[str]:
    """
    Удаляет дублирующиеся паттерны, сохраняя порядок.
    
    Args:
        patterns: Список паттернов для дедупликации
        
    Returns:
        Список уникальных паттернов
    """
```

### Обновленная функция установки
```bash
merge_and_backup_gitignore_toml() {
    # Логика мержа вместо простого копирования
    # Обработка ошибок с fallback
}
```

## Критерии успеха

- [ ] Пользовательские правила сохраняются при обновлении
- [ ] Нет дублирования правил в итоговом файле
- [ ] Структура TOML остается корректной
- [ ] Процесс установки не ломается при ошибках
- [ ] Производительность установки не ухудшается значительно
- [ ] Все существующие функции продолжают работать корректно

## Риски и митигация

- **Риск**: Конфликты в структуре TOML могут сломать парсинг
  - **Митигация**: Строгая валидация и fallback на дистрибутивный файл

- **Риск**: Потеря пользовательских правил при ошибках
  - **Митигация**: Создание backup перед любыми изменениями

- **Риск**: Ухудшение производительности установки
  - **Митигация**: Оптимизация алгоритма мержа и кэширование

## Временные рамки

- Анализ и проектирование: 1 день
- Реализация основных функций: 2 дня
- Тестирование и отладка: 1 день
- Документация и финализация: 0.5 дня

**Общее время: 4.5 дня** 